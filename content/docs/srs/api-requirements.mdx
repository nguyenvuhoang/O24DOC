---
title: "Yêu Cầu API"
description: "API Requirements - Danh sách và đặc tả các API của hệ thống W4S"
---

## 7. Yêu Cầu API (API Requirements)

### 7.1 Tổng Quan API

| Aspect | Specification |
|--------|---------------|
| **Protocol** | HTTPS (TLS 1.3) |
| **Format** | RESTful JSON |
| **Versioning** | URL path (/api/v1/) |
| **Authentication** | Bearer JWT Token |
| **Rate Limit** | 100 requests/minute per user |

### 7.2 Danh Sách API Chính

#### Authentication APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/auth/register` | POST | Đăng ký tài khoản mới |
| `/auth/login` | POST | Đăng nhập |
| `/auth/logout` | POST | Đăng xuất |
| `/auth/refresh` | POST | Refresh access token |
| `/auth/verify-otp` | POST | Xác thực OTP |
| `/auth/forgot-password` | POST | Yêu cầu reset password |
| `/auth/reset-password` | POST | Đặt password mới |
| `/auth/2fa/enable` | POST | Bật 2FA |
| `/auth/2fa/verify` | POST | Xác thực 2FA |

#### User APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/users/me` | GET | Lấy thông tin user hiện tại |
| `/users/me` | PUT | Cập nhật thông tin user |
| `/users/me/password` | PUT | Đổi mật khẩu |
| `/users/me/sessions` | GET | Danh sách phiên đăng nhập |
| `/users/me/sessions/:id` | DELETE | Đăng xuất 1 phiên |

#### Wallet APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/wallets` | GET | Danh sách ví |
| `/wallets` | POST | Tạo ví mới |
| `/wallets/:id` | GET | Chi tiết ví |
| `/wallets/:id` | PUT | Cập nhật ví |
| `/wallets/:id` | DELETE | Xóa/Archive ví |
| `/wallets/:id/adjust` | POST | Điều chỉnh số dư |
| `/wallets/transfer` | POST | Chuyển tiền giữa ví |

#### Transaction APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/transactions` | GET | Danh sách giao dịch (với filter) |
| `/transactions` | POST | Tạo giao dịch mới |
| `/transactions/:id` | GET | Chi tiết giao dịch |
| `/transactions/:id` | PUT | Cập nhật giao dịch |
| `/transactions/:id` | DELETE | Xóa giao dịch |
| `/transactions/:id/duplicate` | POST | Duplicate giao dịch |

#### Category APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/categories` | GET | Danh sách danh mục |
| `/categories` | POST | Tạo danh mục mới |
| `/categories/:id` | PUT | Cập nhật danh mục |
| `/categories/:id` | DELETE | Xóa danh mục |

#### Budget APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/budgets` | GET | Danh sách ngân sách |
| `/budgets` | POST | Tạo ngân sách |
| `/budgets/:id` | GET | Chi tiết & tiến độ |
| `/budgets/:id` | PUT | Cập nhật ngân sách |
| `/budgets/:id` | DELETE | Xóa ngân sách |

#### Recurring APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/recurring` | GET | Danh sách giao dịch định kỳ |
| `/recurring` | POST | Tạo mới |
| `/recurring/:id` | PUT | Cập nhật |
| `/recurring/:id` | DELETE | Xóa |
| `/recurring/:id/skip` | POST | Bỏ qua lần tiếp theo |

#### Debt APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/debts` | GET | Danh sách công nợ |
| `/debts` | POST | Tạo khoản cho vay/đi vay |
| `/debts/:id` | GET | Chi tiết công nợ |
| `/debts/:id/payment` | POST | Ghi nhận trả nợ |
| `/debts/:id/settle` | POST | Đánh dấu đã thanh toán |

#### Saving Goal APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/goals` | GET | Danh sách mục tiêu |
| `/goals` | POST | Tạo mục tiêu mới |
| `/goals/:id` | GET | Chi tiết mục tiêu |
| `/goals/:id` | PUT | Cập nhật mục tiêu |
| `/goals/:id/deposit` | POST | Gửi tiền vào |
| `/goals/:id/withdraw` | POST | Rút tiền ra |

#### Report APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/reports/overview` | GET | Báo cáo tổng quan |
| `/reports/cash-flow` | GET | Dòng tiền theo thời gian |
| `/reports/by-category` | GET | Thống kê theo danh mục |
| `/reports/by-wallet` | GET | Thống kê theo ví |
| `/reports/budget` | GET | Báo cáo ngân sách |
| `/reports/debt` | GET | Báo cáo công nợ |

#### Export APIs
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/export/transactions` | GET | Xuất giao dịch (CSV/Excel/PDF) |
| `/export/reports` | GET | Xuất báo cáo |
| `/import/transactions` | POST | Import giao dịch |
| `/backup` | GET | Backup toàn bộ dữ liệu |
| `/restore` | POST | Khôi phục từ backup |

---
Dưới đây là nội dung đầy đủ cho phần tài liệu về **Learn API**, được trình bày theo định dạng Markdown chuyên nghiệp để bạn có thể thêm vào file README hoặc tạo một file tài liệu riêng (`LEARN_API.md`).

---

# 7.3. Cấu Hình Hệ Thống Learn API

## 7.3.1 Tổng Quan
**Learn API** đóng vai trò là lớp Gateway/Interface trung gian của hệ thống. Nó cho phép định nghĩa các endpoint ảo để tiếp nhận request từ Client (Web/Mobile), thực hiện mapping dữ liệu, xử lý Header (Token) và điều hướng (Route) đến các Controller tương ứng của từng Microservice hoặc gọi trực tiếp vào Workflow.

## 7.3.2 Các Bước Khai Báo Learn API

Để tạo một API mới, bạn cần thực hiện khai báo trong bảng `[o24cms].[dbo].[LearnApi]` tại database hệ thống.

### Bước 1: Khai báo Metadata và Endpoint
Thực hiện chèn bản ghi vào database. Dưới đây là ví dụ khai báo API dùng để tìm kiếm Workflow:

```sql
INSERT INTO [dbo].[LearnApi] (
    [LearnApiId], 
    [LearnApiName], 
    [LearnApiMethod], 
    [Channel], 
    [URI], 
    [LearnApiMapping], 
    [LearnApiHeader], 
    [IsCache], 
    [IsInternal]
) 
VALUES (
    N'LEARN_API_BO_SIMPLE_SEARCH_WF', -- ID định danh duy nhất của API
    N'LEARN_API_BO_SIMPLE_SEARCH_WF', 
    N'POST',                         -- Phương thức HTTP (GET, POST, PUT, DELETE)
    N'BO',                           -- Kênh áp dụng (BO, MB,...)
    N'$WFO$/api/workflowdef/simplesearch', -- URL đích (Sử dụng biến môi trường)
    N'{"search_text":"dataS(searchtext)","page_index":"dataI(pageindex)","page_size":"dataI(pagesize)"}', -- Mapping dữ liệu
    N'{"Authorization":"MapS.getToken(Bearer )"}', -- Cấu hình Header
    '0', 
    NULL
);
```

---

## 3. Đặc Tả Các Thành Phần Cấu Hình

### 3.1. Cấu hình URI ($ServiceVariable$)
Hệ thống sử dụng các biến đại diện cho Base URL của các service để tăng tính linh hoạt khi triển khai trên các môi trường khác nhau (Dev, Staging, Prod):
- `$WFO$`: Trỏ đến Service **Workflow Orchestrator**.
- `$CTH$`: Trỏ đến Service **ControlHub**.
- `$W4S$`: Trỏ đến Service **Wallet**.
- `$NCH$`: Trỏ đến Service **Notification**.

**Ví dụ:** `$WFO$/api/workflowdef/simplesearch` sẽ tự động chuyển đổi thành `http://10.0.x.x:8080/api/workflowdef/simplesearch`.

### 3.2. LearnApiMapping (Request Data Mapping)
Đây là phần quan trọng nhất để chuyển đổi dữ liệu từ Request của Client thành Payload mà Service đích yêu cầu. Hệ thống sử dụng các hàm Handler để ép kiểu:

| Prefix | Ý nghĩa | Ví dụ |
| :--- | :--- | :--- |
| `dataS(key)` | Ép kiểu String | `"name": "dataS(username)"` |
| `dataI(key)` | Ép kiểu Integer | `"age": "dataI(userage)"` |
| `dataN(key)` | Ép kiểu Decimal/Numeric | `"amount": "dataN(price)"` |
| `dataB(key)` | Ép kiểu Boolean | `"is_active": "dataB(status)"` |
| `dataA(key)` | Ép kiểu JsonArray | `"roles": "dataA(role_list)"` |
| `dataO(key)` | Ép kiểu JsonObject | `"info": "dataO(metadata)"` |

### 3.3. LearnApiHeader (Xử lý Header & Security)
Cấu hình các tham số truyền trên Header của request. 
- **Token Handling:** Sử dụng `MapS.getToken(prefix)` để hệ thống tự động lấy Token JWT hiện tại của user đang login và gắn vào Header.
- **Ví dụ:** `{"Authorization":"MapS.getToken(Bearer )"}` sẽ tạo ra Header: `Authorization: Bearer <JWT_TOKEN_HERE>`.

### 3.4. LearnApiMappingResponse (Mapping kết quả trả về)
Nếu Service đích trả về một cấu trúc JSON phức tạp nhưng bạn chỉ muốn trả về một vài trường cho Client, bạn có thể cấu hình mapping tương tự như phần Request tại cột này.

---

## 4. Luồng Xử Lý Của Một Request

1. **Tiếp nhận:** Client gửi request kèm `LearnApiId` (ví dụ: `LEARN_API_BO_SIMPLE_SEARCH_WF`).
2. **Phân giải:** Hệ thống tìm cấu hình trong DB dựa trên ID.
3. **Mapping Header:** Lấy Token, ClientID... gắn vào Header theo cấu hình `LearnApiHeader`.
4. **Mapping Body:** Đọc dữ liệu từ body của Client, sử dụng bộ Handler (`dataS`, `dataI`,...) để build lại JSON Body mới theo `LearnApiMapping`.
5. **Forward:** Gửi request đã được chuẩn hóa tới **URI** đích.
6. **Response:** Nhận kết quả từ service nội bộ, thực hiện mapping response (nếu có) và trả về cho Client.

## 5. Lưu ý quan trọng
- **IsInternal:** Nếu đánh dấu là `1`, API này chỉ có thể gọi nội bộ giữa các service, không public ra ngoài gateway.
- **Method:** Phải khớp với Method được khai báo tại Controller của Service đích.

---